---
params:
  ano: "2025"
server: shiny
---

```{r}
#| label: definir-tema
#| message: false
#| context: setup
knitr::opts_knit$set(root.dir = here::here())

library(shiny)
library(bslib)
library(bsicons)
options(box.path = here::here())


box::use(
  dplyr[`%>%`,
        filter] 
)

```

```{r}
#| label: carregar-dados
#| message: false
#| results: hide
#| context: setup

box::use(
  modulos/carregar_dados[...]
)

```


```{r}
#| label: carregar-visualizacoes
#| message: false
#| context: setup

box::use(
  modulos/titulo_do_relatorio[cabecalho],
  modulos/populacao_e_cadastro,
  modulos/caixas_acessos,
  modulos/grafico_taxa,
  modulos/tp_aparelho,
  modulos/caixas_populacao_brasil,
  modulos/mapa,
  modulos/tabela
)
```


## Row {#cabecalho, height="13%"}
```{r}
#| label: "Header"

div(id = "cabecalho",
    style = "max-height: 240px",
    cabecalho(params$ano),
    selectInput("modalidade",
                "Escolha a modalidade",
                choices = c("Rede Presencial" = "0",
                            "Rede EAD" = "1"))
)
```

## Row {height="11%"}
::: {.card .cartao title="População e cadastro"}

```{r}
#| label: primeiro-segmento
populacao_e_cadastro$ui("PrimeiroSegmento")

```

:::

```{r}
#| label: processa-dados-primeiro-segmento
#| context: server

populacao_filtrada <- reactive({
  req(input$modalidade)
  dados_populacao[[input$modalidade]] %>% 
    filter(DR == DR_selecionado())
})

DR_selecionado <- populacao_e_cadastro$server("PrimeiroSegmento", 
                                              populacao_filtrada)


dados_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  dados_primarios[[input$modalidade]] %>%
    filter(DR == DR_selecionado())
})


```

## Row {height="32%"}

```{r}
#| label: segundo-segmento

card(
  card_header("Informações do acesso ao questionário",
              # style = "font-size: 24px;
              #     text-align: center;
              #     background-color: #8aa8ff;
              #     color: white;
              #     "
  ),
  card_body(
    # style = "background-color: #002a54;
    #          color: white;",
    layout_columns(
      col_widths = c(3, 5, 4),
      caixas_acessos$ui("SegundoSegmento-Caixas"),
      card(
        max_height = "600px",
        card_body(
          grafico_taxa$ui("SegundoSegmento-Acessos")
        )
      ),
      card(
        max_height = "600px",
        card_body(
          tp_aparelho$ui("SegundoSegmento-TipoDeAparelho")
        )
        
      )
    )
  )
)

```


```{r}
#| label: processa-dados-segundo-segmento
#| context: server

caixas_acessos$server("SegundoSegmento-Caixas", 
                      dados_filtrado)
grafico_taxa$server("SegundoSegmento-Acessos",
                    dados_filtrado,
                    DR_selecionado)

tp_aparelho$server("SegundoSegmento-TipoDeAparelho",
                   dados_filtrado,
                   DR_selecionado)

```

## Row {height="44%"}

```{r}
#| label: terceiro-segmento

card(
  card_header("Questionários válidos e Taxa de resposta",
              # style = "font-size: 24px; 
              #    text-align: center;
              #    background-color: #8aa8ff;
              #    color: white;
              #    "
              ),
  
  card_body(
  # style = "background-color: #002a54;
  #                        color: white;",
            layout_columns(
              col_widths = c(4, 4, 4, 6, 6),
              !!!caixas_populacao_brasil$ui("TerceiroSegmento-Caixas")
              ,
              card(
                card_body(
                  max_height = "750px",
                  tabela$ui("TerceiroSegmento-Tabela")
                )
              ),
              
              card(
                card_body(
                  max_height = "750px",
                  mapa$ui("TerceiroSegmento-Mapa")
                )
                
              )
            )
  )
)

```



```{r}
#| label: processa-dados-terceiro-segmento
#| context: server

dados_brasil_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  dados_primarios[[input$modalidade]]
})

populacao_brasil_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  dados_populacao[[input$modalidade]]
})

caixas_populacao_brasil$server("TerceiroSegmento-Caixas", 
                               dados_brasil_filtrado,
                               populacao_brasil_filtrado)

tabela$server("TerceiroSegmento-Tabela", 
              dados_brasil_filtrado,
              opcoes)
mapa$server("TerceiroSegmento-Mapa",
            brasil,
            dados_brasil_filtrado)

```



