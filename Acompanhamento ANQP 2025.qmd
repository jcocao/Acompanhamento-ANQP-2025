---
params:
  ano: "2025"
server: shiny
---

```{r}
#| label: definir-tema
#| message: false
#| context: setup

knitr::opts_knit$set(root.dir = here::here())

library(shiny)
library(bslib)
library(bsicons)
options(box.path = here::here())


box::use(
  dplyr[`%>%`,
        filter] 
)

```

```{r}
#| label: carregar-dados
#| message: false
#| results: hide
#| context: setup

box::use(
  modulos/carregar_dados[...]
)

```


```{r}
#| label: carregar-visualizacoes
#| message: false
#| context: setup

box::use(
  modulos/titulo_do_relatorio[cabecalho],
  modulos/populacao_e_cadastro,
  modulos/caixas_acessos,
  modulos/grafico_taxa,
  modulos/tp_aparelho,
  modulos/caixas_populacao_brasil,
  modulos/mapa,
  modulos/tabela
)


```


## Row {height="9%"}

```{r}
#| label: "Titulo do Relatorio"
```
![](images/header.svg){width="100%"}


## Row {height="5%"}
```{r}
#| label: "Seleções do aplicativo"

div(id = "cabecalho",
    selectizeInput("modalidade",
                "Modalidade",
                choices = c("Rede Presencial" = "0",
                            "Rede EAD" = "1"),
                options = list(dropdownParent = 'body')),
    selectizeInput(
      inputId = "DR",
      label = "Departamento Regional",
      choices = opcoes,
      options = list(dropdownParent = 'body')
    ),
    conditionalPanel(
  condition = "input.DR != 'Brasil'",
  selectizeInput(
    inputId = "unidade",
    label = "Unidade",
    choices = "A",
    options = list(dropdownParent = 'body')
  )
)
)
```

## Row {height="10%"}
::: {.card .cartao title="População e cadastro"}

```{r}
#| label: primeiro-segmento
populacao_e_cadastro$ui("PrimeiroSegmento")

```

:::

```{r}
#| label: processa-dados-primeiro-segmento
#| context: server

DR_selecionado <- reactive({
  req(input$DR)
  input$DR
})

populacao_filtrada <- reactive({
  req(input$modalidade)
  dados_populacao[[input$modalidade]] %>% 
dplyr::add_row(ead = unique(.$ead),
               DR = "BR",
               pop_a = sum(.$pop_a),
               pop_p = sum(.$pop_p),
               tx = sum(.$pop_p) / sum(.$pop_a)) %>% 
    filter(DR == DR_selecionado())
})

populacao_e_cadastro$server("PrimeiroSegmento", 
                             populacao_filtrada)


dados_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  saida <- dados_primarios[[input$modalidade]]

if(DR_selecionado() == "BR"){
saida %>% filter(DR == DR_selecionado())}

saida
})




```

## Row {height="32%"}

```{r}
#| label: segundo-segmento

card(
  card_header("Informações do acesso ao questionário"),
  card_body(
    layout_columns(
      col_widths = c(3, 5, 4),
      caixas_acessos$ui("SegundoSegmento-Caixas"),
      card(id = "grafico-taxa-resposta",
        max_height = "600px",
        card_body(
          grafico_taxa$ui("SegundoSegmento-Acessos")
        )
      ),
      card(
        max_height = "600px",
        card_body(id = "tipo-de-aparelho",
          tp_aparelho$ui("SegundoSegmento-TipoDeAparelho")
        )
        
      )
    )
  )
)

```


```{r}
#| label: processa-dados-segundo-segmento
#| context: server

caixas_acessos$server("SegundoSegmento-Caixas", 
                      dados_filtrado)
grafico_taxa$server("SegundoSegmento-Acessos",
                    dados_filtrado,
                    DR_selecionado)

tp_aparelho$server("SegundoSegmento-TipoDeAparelho",
                   dados_filtrado,
                   DR_selecionado)

```

## Row {height="44%"}

```{r}
#| label: terceiro-segmento

card(
  card_header("Questionários válidos e Taxa de resposta",
              ),
  
  card_body(layout_columns(
              col_widths = c(4, 4, 4, 6, 6),
              !!!caixas_populacao_brasil$ui("TerceiroSegmento-Caixas")
              ,
              card(id = "tabela-terceiro-segmento",
                card_body(
                  min_height = "750px",
                  tabela$ui("TerceiroSegmento-Tabela")
                )
              ),
              
              card(id = "mapa-terceiro-segmento",
                card_body(
                  min_height = "750px",
                  mapa$ui("TerceiroSegmento-Mapa")
                )
                
              )
            )
  )
)

```



```{r}
#| label: processa-dados-terceiro-segmento
#| context: server

dados_brasil_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  dados_primarios[[input$modalidade]]
})

populacao_brasil_filtrado <- reactive({
  req(input$modalidade)
  req(DR_selecionado())
  dados_populacao[[input$modalidade]]
})

caixas_populacao_brasil$server("TerceiroSegmento-Caixas", 
                               dados_brasil_filtrado,
                               populacao_brasil_filtrado)

tabela$server("TerceiroSegmento-Tabela", 
              dados_brasil_filtrado,
              opcoes)
mapa$server("TerceiroSegmento-Mapa",
            brasil,
            dados_brasil_filtrado)

```



